<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="x-poe-datastore-behavior" content="local_only">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
        connect-src 'self' https://data.etabus.gov.hk https://rt.data.gov.hk https://api.allorigins.win;
        frame-src 'self' https://www.youtube.com https://trytako.com;
        child-src 'self';
        manifest-src 'self';
        worker-src 'self';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https://i.imgur.com https://picsum.photos https://images.unsplash.com;
        upgrade-insecure-requests;
        block-all-mixed-content;
    ">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YY Transports ðŸ¦•</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Your existing <style> block here â€“ unchanged, I'm skipping it in this message for length -->

</head>
<body>
    <!-- Your full HTML body here â€“ birthday banner, header, nav-tabs, main content, refresh-btn, dino-decor â€“ unchanged -->

    <script>
        // Dark mode (unchanged)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.toggle('dark', event.matches);
        });

        // MTR station names (unchanged)
        const MTR_STATION_NAMES = { /* your full object here */ };

        function getStationName(code) {
            return MTR_STATION_NAMES[code] || code;
        }

        const CONFIG = {
            KMB_BASE: 'https://data.etabus.gov.hk/v1/transport/kmb',
            MTR_API: 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php',
            WORK_BUS_ROUTE: '690S',
            HOME_BUS_ROUTE: '690S',
            MTR_LINE_TKL: 'TKL',
            MTR_STATION_LHP: 'LHP',
            MTR_STATION_TIK: 'TIK',
            MTR_STATION_NOP: 'NOP'
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //           IMPORTANT: CORS PROXY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const PROXY = 'https://api.allorigins.win/raw?url=';

        let currentPage = 'work';

        // Navigation & switchPage (unchanged)

        // Refresh button listener (unchanged)

        // Time helpers: getMinutesUntil, shouldRun, getTimeClass, formatETA, getETALabel (unchanged)

        // Render helpers: renderLoading, renderError, renderNoData (unchanged)

        async function findStopId(route, direction, stationNamePattern) {
            try {
                const routeStopUrl = `${CONFIG.KMB_BASE}/route-stop/${route}/${direction}/1`;
                const routeStopRes = await fetch(PROXY + encodeURIComponent(routeStopUrl));
                if (!routeStopRes.ok) throw new Error(`Route-stop fetch failed: ${routeStopUrl}`);
                const routeStopData = await routeStopRes.json();

                if (!routeStopData?.data?.length) return null;

                const stopsUrl = `${CONFIG.KMB_BASE}/stop`;
                const stopsRes = await fetch(PROXY + encodeURIComponent(stopsUrl));
                if (!stopsRes.ok) throw new Error(`Stops fetch failed: ${stopsUrl}`);
                const stopsData = await stopsRes.json();

                const stopsMap = Object.fromEntries(stopsData.data.map(s => [s.stop, s]));

                for (const rs of routeStopData.data) {
                    const info = stopsMap[rs.stop];
                    if (info) {
                        const name = (info.name_tc + info.name_en).toLowerCase();
                        if (stationNamePattern.some(p => name.includes(p.toLowerCase()))) {
                            return rs.stop;
                        }
                    }
                }
                return null;
            } catch (err) {
                console.error('findStopId error:', err.message);
                return null;
            }
        }

        async function fetchBusETA(stopId, route) {
            try {
                const url = `${CONFIG.KMB_BASE}/eta/${stopId}/${route}/1`;
                const res = await fetch(PROXY + encodeURIComponent(url));
                if (!res.ok) throw new Error(`ETA fetch failed: ${url}`);
                const { data } = await res.json();
                return data || [];
            } catch (err) {
                console.error('fetchBusETA error:', err.message);
                throw err;
            }
        }

        async function fetchMTRSchedule(line, station) {
            try {
                const url = `${CONFIG.MTR_API}?line=${line}&sta=${station}`;
                const res = await fetch(PROXY + encodeURIComponent(url));
                if (!res.ok) throw new Error(`MTR fetch failed: ${url}`);
                return await res.json();
            } catch (err) {
                console.error('fetchMTRSchedule error:', err.message);
                throw err;
            }
        }

        // renderBusETA (unchanged)

        // renderMTRSchedule & renderMTRScheduleFiltered (unchanged)

        function updateTimestamp(id) {
            const now = new Date();
            document.getElementById(id).textContent = 
                `Last updated: ${now.toLocaleTimeString('en-HK', {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true})} ðŸ¦•`;
        }

        async function refreshData() {
            if (currentPage === 'work') await refreshWorkPage();
            else await refreshHomePage();
        }

        async function refreshWorkPage() {
            const bus = document.getElementById('work-bus-eta');
            const mtr = document.getElementById('work-mtr-eta');
            renderLoading(bus);
            renderLoading(mtr);

            try {
                let stopId = await findStopId('690S', 'outbound', ['æ—¥å‡ºåº·åŸŽ', 'é ˜å‡±', 'lohas', 'visionary']);
                let busData;

                if (stopId) {
                    busData = await fetchBusETA(stopId, '690S');
                } else {
                    const url = `${CONFIG.KMB_BASE}/route-eta/690S/1`;
                    const res = await fetch(PROXY + encodeURIComponent(url));
                    if (res.ok) {
                        const data = await res.json();
                        const filtered = data.data?.filter(item => {
                            const n = (item.dest_tc + item.dest_en).toLowerCase();
                            return n.includes('lohas') || n.includes('åº·åŸŽ') || n.includes('æ—¥å‡º');
                        }) || [];
                        busData = filtered.length ? filtered : (data.data?.slice(0,4) || []);
                    }
                }
                renderBusETA(bus, busData || []);
            } catch {
                renderError(bus);
            }

            try {
                const mtrData = await fetchMTRSchedule(CONFIG.MTR_LINE_TKL, CONFIG.MTR_STATION_LHP);
                renderMTRSchedule(mtr, mtrData, CONFIG.MTR_LINE_TKL, CONFIG.MTR_STATION_LHP);
            } catch {
                renderError(mtr);
            }

            updateTimestamp('work-updated');
        }

        async function refreshHomePage() {
            // Similar structure â€“ apply proxy to all fetches
            // (copy the pattern from refreshWorkPage for bus fallback, mtrNop, mtrTik)
            // Omitted here for brevity â€“ just replace the fetch lines the same way
        }

        refreshData();
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
